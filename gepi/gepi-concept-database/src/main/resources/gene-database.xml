<?xml version="1.0"?>
<conceptdatabase xmlns="http://www.julielab.de/conceptdb"
                 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                 xsi:schemaLocation="http://www.julielab.de/conceptdb http://www.julielab.de/conceptdb/conceptdb-1.1.0.xsd http://www.julielab.de/conceptdb/concepts/ncbigene
                 http://www.julielab.de/conceptdb/concepts/ncbigeneconcepts-1.1.0.xsd
                 http://www.julielab.de/conceptdb/facets/default http://www.julielab.de/conceptdb/facets/defaultfacet-1.1.0.xsd
                 http://www.julielab.de/conceptdb/exporter-1.1.0.xsd">
    <versioning>
        <version>0.2.0-SNAPSHOT</version>
    </versioning>
    <connection>
        <uri>http://darwin:7575</uri>
        <user>neo4j</user>
        <password>julielab</password>
    </connection>
    <preparations>
        <operation>
            <request>
                <rest>
                    <restendpoint>/concepts/indexes/create_indexes</restendpoint>
                    <httpmethod>PUT</httpmethod>
                </rest>
                <parameters>
                    <parameter>neo4j</parameter>
                </parameters>
            </request>
        </operation>
        <operation>
            <request>
                <cypherquery>CREATE INDEX ON :CONCEPT(preferredName_lc)</cypherquery>
            </request>
        </operation>
    </preparations>
    <imports>
        <import name="ncbi_gene_import">
            <rest>
                <restendpoint>/concepts/concept_manager/insert_concepts</restendpoint>
                <httpmethod>POST</httpmethod>
            </rest>
            <concepts>
                <creator xmlns="http://www.julielab.de/conceptdb/concepts/ncbigene">
                    <name>NCBIGeneConceptCreator</name>
                    <configuration>
                        <basepath>/data/erik/geno/build/</basepath>
                        <gene_info>
                            resources/gene_info_organism_filtered.gz
                        </gene_info>
                        <genedescriptions>
                            resources/eg2summary
                        </genedescriptions>
                        <organismlist>
                            makeResourcesAndIndicesTemp/all-species.taxid
                        </organismlist>
                        <organismnames>/data/data_resources/biology/ncbi_tax/names.dmp</organismnames>
                        <homologene>deprecated</homologene>
                        <gene_group>/data/data_resources/biology/entrez/gene/gene_orthologs.gz</gene_group>
                    </configuration>
                </creator>
            </concepts>
            <facet>
                <creator xmlns="http://www.julielab.de/conceptdb/facets/default">
                    <name>DefaultFacetCreator</name>
                    <configuration>
                        <name>NCBI Gene</name>
                        <sourcetype>hierarchical</sourcetype>
                        <facetgroup>
                            <name>BioMed</name>
                        </facetgroup>
                    </configuration>
                </creator>
            </facet>
        </import>
        <import name="famplex_import">
            <rest>
                <restendpoint>/concepts/concept_manager/insert_concepts</restendpoint>
                <httpmethod>POST</httpmethod>
            </rest>
            <concepts>
                <creator>
                    <name>FamPlexConceptCreator</name>
                    <configuration>
                        <relationsfile>
                            famplex-import-files/relations_egids.tsv
                        </relationsfile>
                        <groundingmap>
                            famplex-import-files/grounding_map.tsv
                        </groundingmap>
                        <nameextensionrecords>
                            famplex-import-files/expanded.dict
                        </nameextensionrecords>
                    </configuration>
                </creator>
            </concepts>
            <facet>
                <creator xmlns="http://www.julielab.de/conceptdb/facets/default">
                    <name>DefaultFacetCreator</name>
                    <configuration>
                        <name>FamPlex</name>
                        <sourcetype>hierarchical</sourcetype>
                        <facetgroup>
                            <name>BioMed</name>
                        </facetgroup>
                    </configuration>
                </creator>
            </facet>
        </import>
        <import name="hgnc_groups_import">
            <rest>
                <restendpoint>/concepts/concept_manager/insert_concepts</restendpoint>
                <httpmethod>POST</httpmethod>
            </rest>
            <concepts>
                <creator>
                    <name>HgncGroupsConceptCreator</name>
                    <configuration>
                        <familyfile>
                            hgnc-groups-import-files/family.csv
                        </familyfile>
                        <familyaliasfile>
                            hgnc-groups-import-files/family_alias.csv
                        </familyaliasfile>
                        <hierarchyfile>
                            hgnc-groups-import-files/hierarchy.csv
                        </hierarchyfile>
                        <genetogroupmap>
                            hgnc-groups-import-files/gene_group_ncbi_map.tsv
                        </genetogroupmap>
                    </configuration>
                </creator>
            </concepts>
            <facet>
                <creator xmlns="http://www.julielab.de/conceptdb/facets/default">
                    <name>DefaultFacetCreator</name>
                    <configuration>
                        <name>HGNC</name>
                        <sourcetype>hierarchical</sourcetype>
                        <facetgroup>
                            <name>BioMed</name>
                        </facetgroup>
                    </configuration>
                </creator>
            </facet>
        </import>
    </imports>
    <operations>
        <operation name="copy_aggregate_properties">
            <request>
                <rest>
                    <restendpoint>/concepts/concept_aggregate_manager/copy_aggregate_properties</restendpoint>
                    <httpmethod>PUT</httpmethod>
                </rest>
            </request>
        </operation>
        <operation name="copy_preferred_names_lowercase">
            <request>
                <!-- This requires the APOC core library to be installed -->
                <cypherquery>CALL apoc.periodic.iterate("MATCH (c:CONCEPT) WHERE c.preferredName IS NOT null RETURN c",
                    "SET c.preferredName_lc =
                    toLower(c.preferredName)",{batchSize:1000,iterateList:true,parallel:true,concurrency:50,retries:0})
                    YIELD batches, total
                </cypherquery>
            </request>
        </operation>
    </operations>
    <exports>
        <export name="conceptids">
            <request>
                <rest>
                    <restendpoint>/concepts/export/concept_id_mapping</restendpoint>
                    <httpmethod>GET</httpmethod>
                </rest>
                <parameters>
                    <parameter name="source_id_property">originalId</parameter>
                    <parameter name="target_id_property">id</parameter>
                    <parameter name="labels" toescapedjson="false">
                        <arrayitem>ID_MAP_NCBI_GENES</arrayitem>
                    </parameter>
                </parameters>
            </request>
            <outputfile>es-consumer-resources/egid2tid.map</outputfile>
        </export>
        <export name="allgeneaggregates">
            <request>
                <cypherquery>MATCH (th)-[:HAS_ELEMENT*]->(c:CONCEPT) WHERE (th:AGGREGATE_GENEGROUP OR
                    th:AGGREGATE_TOP_ORTHOLOGY) AND NOT c:AGGREGATE with c.id as cid,COLLECT(DISTINCT th.id) AS atids
                    RETURN
                    cid, REDUCE(acc=HEAD(atids), atid in TAIL(atids) | acc + "|" + atid)
                </cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2atid.map</outputfile>
        </export>
        <export name="tophomologyids">
            <request>
                <cypherquery>MATCH (th:AGGREGATE_GENEGROUP)-[:HAS_ELEMENT*1..5]->(c:CONCEPT) WHERE NOT c:AGGREGATE
                    RETURN DISTINCT c.id,th.id
                </cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2tophomo.map</outputfile>
        </export>
        <export name="preferredNames">
            <request>
                <cypherquery>MATCH (gene:ID_MAP_NCBI_GENES) return gene.id,gene.preferredName</cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2prefName.map</outputfile>
        </export>
        <export name="preferredTophomologyNames">
            <request>
                <cypherquery>MATCH (c:ID_MAP_NCBI_GENES) WITH c OPTIONAL MATCH
                    (c)-[:HAS_ELEMENT]-(a:AGGREGATE_GENEGROUP) WITH c,a OPTIONAL MATCH
                    (a)-[:HAS_ELEMENT]-(top:AGGREGATE_TOP_ORTHOLOGY) RETURN DISTINCT c.id, COALESCE(top.preferredName,
                    a.preferredName,
                    c.preferredName)
                </cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2topHomologyPrefName.map</outputfile>
        </export>
        <!-- Export a map from NCBI Gene tids to all the FamPlex concept tids it is directly or indirectly connected with -->
        <export name="tid2famplex">
            <request>
                <cypherquery>MATCH p=(f:FPLX)&lt;-[:isa|partof*]-(c:ID_MAP_NCBI_GENES) WITH reverse([x IN nodes(p) |
                    x.id]) AS idlist RETURN head(idlist),reduce(acc=head(tail(idlist)), fplxid IN tail(tail(idlist)) |
                    acc + "|" + fplxid)
                </cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2famplex.map</outputfile>
        </export>
        <export name="tid2hgncgroups">
            <request>
                <!-- The 'not' clause is there to ensure that only paths from the highest HGNC group are returned; this avoids partial paths that are just subpaths of the longest one. -->
                <cypherquery>MATCH p=(h:HGNC_GROUP)-[:IS_BROADER_THAN*]->(c:ID_MAP_NCBI_GENES) WHERE
                    not((:HGNC_GROUP)-[:IS_BROADER_THAN]->(h)) WITH reverse([x IN nodes(p) | x.id]) AS idlist RETURN
                    head(idlist),reduce(acc=head(tail(idlist)),hgncid in tail(tail(idlist)) | acc + "|" + hgncid)
                </cypherquery>
            </request>
            <outputfile>es-consumer-resources/tid2hgncgroups.map</outputfile>
        </export>
        <export name="tid2famplexnames">
            <request>
                <rest>
                    <restendpoint>/concepts/export/lingpipe_dictionary</restendpoint>
                    <httpmethod>GET</httpmethod>
                </rest>
                <parameters>
                    <parameter name="label">FPLX</parameter>
                </parameters>
            </request>
            <decoding>
                <base64>true</base64>
                <gzip>true</gzip>
            </decoding>
            <outputfile>processing-dictionaries/famplex.dict</outputfile>
        </export>
    </exports>
</conceptdatabase>